<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PE Visual War Map - Optimized</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #0f0f23; color: #e2e8f0; overflow: hidden; }
        
        #app { width: 100vw; height: 100vh; display: flex; flex-direction: column; }
        
        /* Controls */
        .controls { background: rgba(15,23,42,0.95); padding: 1rem; display: flex; gap: 1rem; align-items: center; border-bottom: 1px solid rgba(100,116,139,0.3); backdrop-filter: blur(10px); }
        .search-box { flex: 1; max-width: 400px; }
        .search-box input, .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.5rem 1rem; background: rgba(30,41,59,0.8); border: 1px solid rgba(100,116,139,0.3); border-radius: 8px; color: #e2e8f0; font-size: 14px; }
        .search-box input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        
        button { padding: 0.5rem 1rem; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; color: #93c5fd; cursor: pointer; font-size: 13px; transition: all 0.2s; }
        button:hover { background: rgba(59,130,246,0.2); transform: translateY(-1px); }
        button.active { background: rgba(59,130,246,0.3); border-color: #3b82f6; color: #dbeafe; }
        
        /* Views */
        .view-container { flex: 1; position: relative; overflow: hidden; display: none; }
        .view-container.active { display: block; }
        #kanban-view.active { display: flex; }
        
        canvas, #map-container svg { width: 100%; height: 100%; cursor: grab; }
        canvas:active, #map-container svg:active { cursor: grabbing; }
        
        .map-country { fill: rgba(30,41,59,0.5); stroke: rgba(100,116,139,0.3); stroke-width: 0.5; }
        .map-bubble { fill: #3b82f6; stroke: rgba(255,255,255,0.2); stroke-width: 0.5; opacity: 0.9; cursor: pointer; transition: all 0.2s; }
        .map-bubble:hover { stroke: #93c5fd; stroke-width: 1.5; opacity: 1; }
        .map-bubble-label { fill: #e2e8f0; font-size: 11px; pointer-events: none; text-anchor: middle; opacity: 0; transition: opacity 0.2s; }
        .map-bubble-group:hover .map-bubble-label { opacity: 1; }
        
        /* Panel */
        #firm-panel { position: fixed; right: -400px; top: 0; width: 400px; height: 100%; background: rgba(15,23,42,0.98); border-left: 1px solid rgba(100,116,139,0.3); transition: right 0.3s; z-index: 200; overflow-y: auto; backdrop-filter: blur(20px); }
        #firm-panel.open { right: 0; }
        .panel-header { padding: 1.5rem; border-bottom: 1px solid rgba(100,116,139,0.3); position: relative; }
        .close-panel { position: absolute; right: 1rem; top: 1rem; width: 32px; height: 32px; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 6px; color: #f87171; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .firm-name { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.5rem; }
        .firm-aum { color: #94a3b8; font-size: 1.1rem; }
        
        /* Progress */
        .progress-section { padding: 1.5rem; border-bottom: 1px solid rgba(100,116,139,0.3); }
        .progress-bar { height: 40px; background: rgba(30,41,59,0.5); border-radius: 8px; position: relative; overflow: hidden; margin-top: 1rem; }
        .progress-fill { height: 100%; background: linear-gradient(90deg,#64748b,#6366f1,#4f46e5,#2563eb,#0ea5e9,#06b6d4,#10b981,#ef4444); transition: width 0.5s; border-radius: 8px; }
        .progress-stages { display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 11px; color: #64748b; }
        
        /* People */
        .people-section { padding: 1.5rem; }
        .people-grid { display: flex; flex-direction: column; gap: 1rem; margin-top: 1rem; }
        .role-group { padding: 0.75rem; background: rgba(30,41,59,0.3); border-radius: 8px; }
        .role-title { font-size: 12px; font-weight: 600; color: #94a3b8; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .person-bubble { display: inline-flex; flex-direction: column; align-items: center; padding: 0.75rem; margin: 0.25rem; background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 12px; cursor: pointer; transition: all 0.2s; }
        .person-bubble:hover { background: rgba(59,130,246,0.2); transform: scale(1.05); }
        .person-name { font-size: 13px; font-weight: 500; margin-bottom: 0.25rem; }
        .person-title { font-size: 11px; color: #94a3b8; text-align: center; }
        .last-contact { font-size: 10px; color: #10b981; margin-top: 0.25rem; }
        
        /* Kanban */
        .kanban-column { min-width: 280px; background: rgba(30,41,59,0.3); border-radius: 8px; margin-right: 1rem; padding: 1rem; height: 100%; overflow-y: auto; }
        .kanban-header { font-weight: 600; margin-bottom: 1rem; padding: 0.5rem; background: rgba(59,130,246,0.1); border-radius: 6px; text-align: center; }
        .kanban-card { background: rgba(15,23,42,0.8); border: 1px solid rgba(100,116,139,0.3); border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: move; transition: all 0.2s; }
        .kanban-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .kanban-card-name { font-weight: 500; margin-bottom: 0.25rem; }
        .kanban-card-aum { font-size: 12px; color: #94a3b8; }
        
        /* Modal */
        #data-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 300; align-items: center; justify-content: center; }
        #data-modal.open { display: flex; }
        .modal-content { background: #1e293b; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 13px; font-weight: 500; margin-bottom: 0.5rem; color: #94a3b8; }
        .form-group input { padding: 0.5rem; }
        .form-actions { display: flex; gap: 0.5rem; margin-top: 1.5rem; }
        
        .stage-indicator { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 12px; font-weight: 600; margin-left: 0.5rem; }
        .stage-1 { background: #64748b; }
        .stage-2 { background: #6366f1; }
        .stage-3 { background: #4f46e5; }
        .stage-4 { background: #2563eb; }
        .stage-5 { background: #0ea5e9; }
        .stage-6 { background: #06b6d4; }
        .stage-7 { background: #10b981; }
        .stage-8 { background: #ef4444; }
        
        .map-tooltip { position: absolute; background: rgba(15,23,42,0.95); border: 1px solid rgba(100,116,139,0.5); border-radius: 6px; padding: 0.5rem; font-size: 12px; pointer-events: none; z-index: 1000; opacity: 0; transition: opacity 0.2s; }
        .map-tooltip.visible { opacity: 1; }
    </style>
</head>
<body>
    <div id="app">
        <div class="controls">
            <div class="search-box">
                <input type="text" id="search-input" placeholder="Search for a PE firm...">
            </div>
            <div class="view-controls">
                <button id="view-map" class="active">Map View</button>
                <button id="view-scatter">Scatter View</button>
                <button id="view-kanban">Kanban View</button>
                <button id="sort-reset" data-sort="none" style="display:none;">Reset Layout</button>
                <button id="sort-aum" data-sort="aum" style="display:none;">Sort by AUM</button>
                <button id="sort-stage" data-sort="stage" style="display:none;">Sort by Stage</button>
                <button id="sort-people" data-sort="people" style="display:none;">Sort by People</button>
            </div>
            <div class="data-controls" style="margin-left:auto;display:flex;gap:0.5rem;">
                <button id="add-firm">Add Firm</button>
                <button id="import-data">Import CSV</button>
                <button id="export-data">Export Data</button>
            </div>
        </div>

        <div id="map-container" class="view-container active">
            <svg id="world-map"></svg>
            <div class="map-tooltip"></div>
        </div>

        <div id="canvas-container" class="view-container">
            <canvas id="main-canvas"></canvas>
        </div>

        <div id="kanban-view" class="view-container"></div>

        <div id="firm-panel">
            <div class="panel-header">
                <div class="close-panel" id="close-panel">âœ•</div>
                <div class="firm-name" id="panel-firm-name"></div>
                <div class="firm-aum" id="panel-firm-aum"></div>
                <span class="stage-indicator" id="panel-stage"></span>
            </div>
            <div class="progress-section">
                <div style="font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.05em;">Pipeline Progress</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <div class="progress-stages" id="progress-stages"></div>
            </div>
            <div class="people-section">
                <div style="display:flex;align-items:center;justify-content:space-between;">
                    <div style="font-size:12px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:0.05em;">Team Members</div>
                    <button id="add-person" style="padding:0.25rem 0.5rem;font-size:12px;">Add Person</button>
                </div>
                <div class="people-grid" id="people-grid"></div>
            </div>
        </div>

        <div id="data-modal">
            <div class="modal-content">
                <div class="modal-title" id="modal-title">Add New Firm</div>
                <form id="firm-form">
                    <div class="form-group">
                        <label>Firm Name</label>
                        <input type="text" id="form-name" required>
                    </div>
                    <div class="form-group">
                        <label>AUM (in billions)</label>
                        <input type="number" id="form-aum" step="0.1" min="1" required>
                    </div>
                    <div class="form-group">
                        <label>Headquarters Location</label>
                        <select id="form-location"></select>
                    </div>
                    <div class="form-group">
                        <label>Pipeline Stage</label>
                        <select id="form-stage"></select>
                    </div>
                    <div class="form-group">
                        <label>Number of Investment Professionals</label>
                        <input type="number" id="form-people-count" min="0">
                    </div>
                    <div class="form-actions">
                        <button type="submit">Save Firm</button>
                        <button type="button" id="cancel-modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="pe-firms-data.js"></script>
    <script>
        const CONFIG = {
            STORAGE_KEY: 'peFirms',
            SOURCE_KEY: 'peFirmsSource',
            STAGE_NAMES: ['No Contact','Initial Engagement','Broader Demo Evaluation (NDA, POC, Pilot)','Validation (Docs Uploaded)','Commercials (Contract Negotiations)','Decision (Exploring Others)','Closed Won','Closed Lost'],
            STAGE_COLORS: ['#64748b','#6366f1','#4f46e5','#2563eb','#0ea5e9','#06b6d4','#10b981','#ef4444'],
            CITY_COORDS: {
                'New York': [40.7128,-74.0060], 'London': [51.5074,-0.1278], 'Paris': [48.8566,2.3522],
                'San Francisco': [37.7749,-122.4194], 'Boston': [42.3601,-71.0589], 'Chicago': [41.8781,-87.6298],
                'Miami': [25.7617,-80.1918], 'Luxembourg': [49.6117,6.1319], 'Tel Aviv': [32.0853,34.7818],
                'Hong Kong': [22.3193,114.1694], 'Sydney': [-33.8688,151.2093], 'Beijing': [39.9042,116.4074],
                'Dubai': [25.2048,55.2708], 'Toronto': [43.6532,-79.3832], 'Zurich': [47.3769,8.5417],
                'Denver': [39.7392,-104.9903], 'Seattle': [47.6062,-122.3321], 'Austin': [30.2672,-97.7431],
                'Los Angeles': [34.0522,-118.2437], 'Munich': [48.1351,11.5820]
            },
            CITY_TO_COUNTRY: {
                'New York':'USA','San Francisco':'USA','Boston':'USA','Chicago':'USA','Miami':'USA',
                'Denver':'USA','Seattle':'USA','Austin':'USA','Los Angeles':'USA','London':'GBR',
                'Paris':'FRA','Luxembourg':'LUX','Tel Aviv':'ISR','Hong Kong':'CHN','Sydney':'AUS',
                'Beijing':'CHN','Dubai':'ARE','Toronto':'CAN','Zurich':'CHE','Munich':'DEU'
            },
            COUNTRY_IDS: {840:'USA',826:'GBR',250:'FRA',442:'LUX',376:'ISR',156:'CHN',36:'AUS',784:'ARE',124:'CAN',756:'CHE',276:'DEU'}
        };

        const state = {
            firms: [],
            currentFirm: null,
            currentSort: 'none',
            viewMode: 'map',
            canvas: null,
            ctx: null,
            camera: {x:0, y:0, zoom:1},
            isDragging: false,
            dragStart: {x:0, y:0},
            hoveredFirm: null,
            animationFrame: null,
            mapSvg: null,
            mapG: null,
            mapProjection: null,
            mapZoom: null
        };

        // Utility functions
        const $ = id => document.getElementById(id);
        const normalizeStage = v => Math.min(Math.max(parseInt(v,10)||1, 1), CONFIG.STAGE_NAMES.length);
        const getStageName = s => CONFIG.STAGE_NAMES[s-1] || 'Unknown';
        const getStageColor = s => CONFIG.STAGE_COLORS[normalizeStage(s)-1];

        function withBasePosition(firm) {
            const baseX = firm.baseX ?? firm.x ?? Math.random()*2000-1000;
            const baseY = firm.baseY ?? firm.y ?? Math.random()*2000-1000;
            return {...firm, stage: normalizeStage(firm.stage), baseX, baseY, x: firm.x ?? baseX, y: firm.y ?? baseY};
        }

        function loadData() {
            try {
                const stored = JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEY)) || [];
                const source = localStorage.getItem(CONFIG.SOURCE_KEY);
                const dataset = (window.PE_FIRMS_DATA || []).map((f,i) => withBasePosition({
                    ...f,
                    id: f.id || `firm_dataset_${i}`,
                    name: f.name || `Firm ${i+1}`,
                    aum: f.aum ?? Math.max((f.aum_m||0)/1000, 1),
                    peopleCount: f.peopleCount ?? (f.people?.length || 0),
                    people: f.people || [],
                    hqLocation: f.hqLocation || null
                }));

                if (dataset.length && (!stored.length || source === 'dataset' || source === 'sample')) {
                    state.firms = dataset;
                    persistFirms('dataset');
                } else if (stored.length) {
                    state.firms = stored.map(withBasePosition);
                } else {
                    state.firms = generateSampleData();
                    persistFirms('sample');
                }
            } catch (e) {
                state.firms = generateSampleData();
                persistFirms('sample');
            }
        }

        function generateSampleData() {
            const names = ['Atlas Capital','Vertex Ventures','Summit Partners','Silver Lake','Thoma Bravo',
                'Vista Equity','Insight Partners','General Atlantic','KKR','Blackstone'];
            const cities = Object.keys(CONFIG.CITY_COORDS);
            return names.map((name,i) => withBasePosition({
                id: `firm_${Date.now()}_${i}`,
                name,
                aum: Math.random()*100+1,
                stage: Math.floor(Math.random()*CONFIG.STAGE_NAMES.length)+1,
                peopleCount: Math.floor(Math.random()*50)+5,
                people: [],
                hqLocation: cities[Math.floor(Math.random()*cities.length)]
            }));
        }

        function persistFirms(source) {
            localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.firms));
            if (source) localStorage.setItem(CONFIG.SOURCE_KEY, source);
        }

        // Canvas functions
        function setupCanvas() {
            state.canvas = $('main-canvas');
            state.ctx = state.canvas.getContext('2d');
            resizeCanvas();
        }

        function resizeCanvas() {
            const container = $('canvas-container');
            state.canvas.width = container.clientWidth;
            state.canvas.height = container.clientHeight;
        }

        function startAnimation() {
            if (!state.animationFrame) {
                state.animationFrame = requestAnimationFrame(animate);
            }
        }

        function stopAnimation() {
            if (state.animationFrame) {
                cancelAnimationFrame(state.animationFrame);
                state.animationFrame = null;
            }
        }

        function animate() {
            if (state.viewMode !== 'scatter') {
                stopAnimation();
                return;
            }
            const {ctx, canvas, camera, firms} = state;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(camera.zoom, camera.zoom);
            ctx.translate(-canvas.width/2 + camera.x, -canvas.height/2 + camera.y);
            
            firms.forEach(firm => {
                const radius = Math.sqrt(firm.aum) * 5;
                const isHovered = state.hoveredFirm?.id === firm.id;
                const scale = isHovered ? 1.1 : 1;
                
                ctx.save();
                ctx.translate(firm.x, firm.y);
                ctx.scale(scale, scale);
                
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, radius);
                const color = getStageColor(firm.stage);
                gradient.addColorStop(0, color + '80');
                gradient.addColorStop(1, color + '20');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.fillStyle = '#e2e8f0';
                ctx.font = `${Math.min(14, radius/3)}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(firm.name, 0, -5);
                
                ctx.fillStyle = '#94a3b8';
                ctx.font = `${Math.min(11, radius/4)}px sans-serif`;
                ctx.fillText(`${firm.aum.toFixed(1)}B`, 0, 10);
                
                ctx.restore();
            });
            
            ctx.restore();
            state.animationFrame = requestAnimationFrame(animate);
        }

        // Map functions
        async function initMap() {
            const container = $('map-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            state.mapSvg = d3.select('#world-map');
            state.mapG = state.mapSvg.append('g');
            state.mapProjection = d3.geoMercator()
                .scale((width/2/Math.PI)*0.8)
                .translate([width/2, height/1.8]);
            
            const path = d3.geoPath().projection(state.mapProjection);
            
            state.mapZoom = d3.zoom()
                .scaleExtent([0.5, 8])
                .on('zoom', event => {
                    state.mapG.attr('transform', event.transform);
                    state.mapG.selectAll('.map-bubble-label')
                        .style('font-size', `${11/Math.sqrt(event.transform.k)}px`);
                });
            
            state.mapSvg.call(state.mapZoom);
            
            try {
                const world = await d3.json('https://unpkg.com/world-atlas@2.0.2/countries-110m.json');
                const countries = topojson.feature(world, world.objects.countries);
                
                state.mapG.selectAll('path')
                    .data(countries.features)
                    .join('path')
                    .attr('class', 'map-country')
                    .attr('d', path);
                
                updateMapBubbles();
            } catch (e) {
                console.error('Error loading map:', e);
            }
        }

        function updateMapBubbles() {
            if (!state.mapG) return;
            
            const countryStages = {};
            state.firms.forEach(f => {
                const country = CONFIG.CITY_TO_COUNTRY[f.hqLocation];
                if (country) {
                    if (!countryStages[country]) countryStages[country] = {total:0, count:0};
                    countryStages[country].total += f.stage;
                    countryStages[country].count++;
                }
            });
            
            Object.keys(countryStages).forEach(c => {
                countryStages[c].average = countryStages[c].total / countryStages[c].count;
            });
            
            state.mapG.selectAll('.map-country')
                .transition().duration(500)
                .style('fill', d => {
                    const country = CONFIG.COUNTRY_IDS[d.id];
                    if (country && countryStages[country]) {
                        return getStageColor(Math.round(countryStages[country].average)) + '30';
                    }
                    return 'rgba(30,41,59,0.5)';
                });
            
            const geocoded = state.firms.filter(f => f.hqLocation && CONFIG.CITY_COORDS[f.hqLocation]);
            
            state.mapG.selectAll('.map-bubble-group').remove();
            
            const groups = state.mapG.selectAll('.map-bubble-group')
                .data(geocoded)
                .enter().append('g')
                .attr('class', 'map-bubble-group');
            
            groups.append('circle')
                .attr('class', 'map-bubble')
                .attr('r', d => Math.max(4, Math.sqrt(d.aum)*0.6))
                .attr('cx', d => state.mapProjection([CONFIG.CITY_COORDS[d.hqLocation][1], CONFIG.CITY_COORDS[d.hqLocation][0]])[0])
                .attr('cy', d => state.mapProjection([CONFIG.CITY_COORDS[d.hqLocation][1], CONFIG.CITY_COORDS[d.hqLocation][0]])[1])
                .style('fill', d => getStageColor(d.stage))
                .on('click', (e,d) => {e.stopPropagation(); openFirmPanel(d);})
                .on('mouseover', function(e,d) {
                    d3.select(this).transition().duration(200).attr('r', Math.max(6, Math.sqrt(d.aum)*0.8));
                    const tooltip = document.querySelector('.map-tooltip');
                    tooltip.innerHTML = `<strong>${d.name}</strong><br>AUM: $${d.aum.toFixed(1)}B<br>HQ: ${d.hqLocation}<br>Stage: ${getStageName(d.stage)}`;
                    tooltip.style.left = (e.pageX+10)+'px';
                    tooltip.style.top = (e.pageY-10)+'px';
                    tooltip.classList.add('visible');
                })
                .on('mouseout', function(e,d) {
                    d3.select(this).transition().duration(200).attr('r', Math.max(4, Math.sqrt(d.aum)*0.6));
                    document.querySelector('.map-tooltip').classList.remove('visible');
                });
            
            groups.append('text')
                .attr('class', 'map-bubble-label')
                .attr('x', d => state.mapProjection([CONFIG.CITY_COORDS[d.hqLocation][1], CONFIG.CITY_COORDS[d.hqLocation][0]])[0])
                .attr('y', d => state.mapProjection([CONFIG.CITY_COORDS[d.hqLocation][1], CONFIG.CITY_COORDS[d.hqLocation][0]])[1] + Math.max(4, Math.sqrt(d.aum)*0.6) + 12)
                .text(d => d.name);
        }

        // View management
        function setView(mode) {
            state.viewMode = mode;
            
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('#view-map, #view-scatter, #view-kanban').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('[data-sort]').forEach(b => b.style.display = 'none');
            
            if (mode === 'map') {
                $('map-container').classList.add('active');
                $('view-map').classList.add('active');
                stopAnimation();
                updateMapBubbles();
            } else if (mode === 'scatter') {
                $('canvas-container').classList.add('active');
                $('view-scatter').classList.add('active');
                document.querySelectorAll('[data-sort]').forEach(b => b.style.display = 'inline-block');
                resizeCanvas();
                startAnimation();
            } else if (mode === 'kanban') {
                $('kanban-view').classList.add('active');
                $('view-kanban').classList.add('active');
                stopAnimation();
                renderKanban();
            }
        }

        function renderKanban() {
            const container = $('kanban-view');
            container.innerHTML = CONFIG.STAGE_NAMES.map((name, i) => {
                const firms = state.firms.filter(f => f.stage === i + 1);
                return `
                    <div class="kanban-column" data-stage="${i+1}">
                        <div class="kanban-header stage-${i+1}">${i+1}. ${name}</div>
                        ${firms.map(f => `
                            <div class="kanban-card" draggable="true" data-firm-id="${f.id}">
                                <div class="kanban-card-name">${f.name}</div>
                                <div class="kanban-card-aum">$${f.aum.toFixed(1)}B AUM</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
            
            container.querySelectorAll('.kanban-card').forEach(card => {
                card.onclick = () => openFirmPanel(state.firms.find(f => f.id === card.dataset.firmId));
                card.ondragstart = e => e.dataTransfer.setData('firmId', card.dataset.firmId);
            });
            
            container.querySelectorAll('.kanban-column').forEach(col => {
                col.ondragover = e => e.preventDefault();
                col.ondrop = e => {
                    e.preventDefault();
                    const firm = state.firms.find(f => f.id === e.dataTransfer.getData('firmId'));
                    if (firm) {
                        firm.stage = normalizeStage(col.dataset.stage);
                        persistFirms();
                        renderKanban();
                        updateMapBubbles();
                        if (state.currentFirm?.id === firm.id) openFirmPanel(firm);
                    }
                };
            });
        }

        // Sorting
        function sortBy(type) {
            if (state.viewMode !== 'scatter') return;
            state.currentSort = type;
            
            if (type === 'none') {
                state.firms = state.firms.map(f => ({...f, x: f.baseX, y: f.baseY}));
            } else {
                const sortKey = type === 'people' ? 'peopleCount' : type;
                state.firms.sort((a,b) => b[sortKey] - a[sortKey]);
                const cols = Math.ceil(Math.sqrt(state.firms.length));
                state.firms.forEach((f,i) => {
                    f.x = 100 + (i%cols) * 150;
                    f.y = 100 + Math.floor(i/cols) * 150;
                });
            }
            
            document.querySelectorAll('[data-sort]').forEach(b => {
                b.classList.toggle('active', b.dataset.sort === type);
            });
            persistFirms();
        }

        // Panel functions
        function openFirmPanel(firm) {
            state.currentFirm = firm;
            $('firm-panel').classList.add('open');
            $('panel-firm-name').textContent = firm.name;
            $('panel-firm-aum').textContent = `$${firm.aum.toFixed(1)}B AUM`;
            
            const stage = normalizeStage(firm.stage);
            const stageEl = $('panel-stage');
            stageEl.textContent = `${stage}. ${getStageName(stage)}`;
            stageEl.className = `stage-indicator stage-${stage}`;
            
            $('progress-fill').style.width = `${((stage-1)/(CONFIG.STAGE_NAMES.length-1))*100}%`;
            
            const peopleGrid = $('people-grid');
            const roleGroups = {};
            (firm.people || []).forEach(p => {
                const role = p.role || 'Other';
                if (!roleGroups[role]) roleGroups[role] = [];
                roleGroups[role].push(p);
            });
            
            peopleGrid.innerHTML = Object.entries(roleGroups).map(([role, people]) => 
                people.length ? `
                    <div class="role-group">
                        <div class="role-title">${role}</div>
                        ${people.map(p => `
                            <div class="person-bubble">
                                <div class="person-name">${p.name}</div>
                                <div class="person-title">${p.title || role}</div>
                                <div class="last-contact">${p.lastContact ? 
                                    `${Math.floor((Date.now() - new Date(p.lastContact))/(24*60*60*1000))}d ago` : 
                                    'No contact'}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''
            ).join('');
        }

        // Event handlers
        function setupEventListeners() {
            // Canvas events
            const canvas = state.canvas;
            canvas.onmousedown = e => {
                if (state.viewMode !== 'scatter') return;
                state.isDragging = true;
                state.dragStart = {x: e.clientX - state.camera.x, y: e.clientY - state.camera.y};
                canvas.style.cursor = 'grabbing';
            };
            
            canvas.onmousemove = e => {
                if (state.viewMode !== 'scatter') return;
                if (state.isDragging) {
                    state.camera.x = e.clientX - state.dragStart.x;
                    state.camera.y = e.clientY - state.dragStart.y;
                } else {
                    const rect = canvas.getBoundingClientRect();
                    const x = (e.clientX - rect.left - canvas.width/2)/state.camera.zoom + canvas.width/2 - state.camera.x;
                    const y = (e.clientY - rect.top - canvas.height/2)/state.camera.zoom + canvas.height/2 - state.camera.y;
                    
                    state.hoveredFirm = null;
                    for (const firm of state.firms) {
                        const dx = x - firm.x, dy = y - firm.y;
                        if (Math.sqrt(dx*dx + dy*dy) < Math.sqrt(firm.aum)*5) {
                            state.hoveredFirm = firm;
                            canvas.style.cursor = 'pointer';
                            break;
                        }
                    }
                    if (!state.hoveredFirm) canvas.style.cursor = 'grab';
                }
            };
            
            canvas.onmouseup = () => {
                state.isDragging = false;
                canvas.style.cursor = 'grab';
            };
            
            canvas.onwheel = e => {
                if (state.viewMode !== 'scatter') return;
                e.preventDefault();
                state.camera.zoom = Math.max(0.1, Math.min(3, state.camera.zoom * (e.deltaY > 0 ? 0.9 : 1.1)));
            };
            
            canvas.onclick = () => {
                if (state.hoveredFirm) openFirmPanel(state.hoveredFirm);
            };
            
            // Search
            $('search-input').oninput = e => {
                const query = e.target.value.toLowerCase();
                if (query.length < 2) return;
                const found = state.firms.find(f => f.name.toLowerCase().includes(query));
                if (!found) return;
                
                if (state.viewMode === 'scatter') {
                    const targetX = -found.x + canvas.width/2;
                    const targetY = -found.y + canvas.height/2;
                    const steps = 30;
                    let step = 0;
                    const startX = state.camera.x, startY = state.camera.y, startZoom = state.camera.zoom;
                    
                    function animateTo() {
                        step++;
                        const eased = 1 - Math.pow(1 - step/steps, 3);
                        state.camera.x = startX + (targetX - startX) * eased;
                        state.camera.y = startY + (targetY - startY) * eased;
                        state.camera.zoom = startZoom + (1.5 - startZoom) * eased;
                        if (step < steps) requestAnimationFrame(animateTo);
                    }
                    animateTo();
                    state.hoveredFirm = found;
                } else if (state.viewMode === 'map' && found.hqLocation && CONFIG.CITY_COORDS[found.hqLocation]) {
                    const coords = CONFIG.CITY_COORDS[found.hqLocation];
                    const [x,y] = state.mapProjection([coords[1], coords[0]]);
                    state.mapSvg.transition().duration(750).call(
                        state.mapZoom.transform,
                        d3.zoomIdentity.translate(window.innerWidth/2, window.innerHeight/2).scale(4).translate(-x, -y)
                    );
                }
            };
            
            // View buttons
            $('view-map').onclick = () => setView('map');
            $('view-scatter').onclick = () => setView('scatter');
            $('view-kanban').onclick = () => setView('kanban');
            
            // Sort buttons
            document.querySelectorAll('[data-sort]').forEach(btn => {
                btn.onclick = () => sortBy(btn.dataset.sort);
            });
            
            // Data buttons
            $('add-firm').onclick = () => {
                $('data-modal').classList.add('open');
                $('firm-form').reset();
            };
            
            $('export-data').onclick = () => {
                const a = document.createElement('a');
                a.href = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(state.firms, null, 2));
                a.download = `pe_firms_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
            };
            
            $('import-data').onclick = () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'application/json';
                input.onchange = e => {
                    const reader = new FileReader();
                    reader.onload = evt => {
                        try {
                            state.firms = JSON.parse(evt.target.result).map(withBasePosition);
                            persistFirms('user');
                            updateMapBubbles();
                            alert('Data imported successfully!');
                        } catch (err) {
                            alert('Error importing data: ' + err.message);
                        }
                    };
                    reader.readAsText(e.target.files[0]);
                };
                input.click();
            };
            
            // Form
            $('firm-form').onsubmit = e => {
                e.preventDefault();
                const newFirm = withBasePosition({
                    id: 'firm_' + Date.now(),
                    name: $('form-name').value,
                    aum: parseFloat($('form-aum').value),
                    stage: normalizeStage($('form-stage').value),
                    peopleCount: parseInt($('form-people-count').value) || 0,
                    people: [],
                    hqLocation: $('form-location').value || null
                });
                state.firms.push(newFirm);
                persistFirms('user');
                updateMapBubbles();
                $('data-modal').classList.remove('open');
            };
            
            $('cancel-modal').onclick = () => $('data-modal').classList.remove('open');
            $('close-panel').onclick = () => {
                $('firm-panel').classList.remove('open');
                state.currentFirm = null;
            };
            
            $('add-person').onclick = () => {
                if (!state.currentFirm) return;
                const name = prompt('Enter person name:');
                if (!name) return;
                const role = prompt('Enter role (GP/MD/Principal/VP/Associate/Other):') || 'Other';
                
                if (!state.currentFirm.people) state.currentFirm.people = [];
                state.currentFirm.people.push({
                    id: 'person_' + Date.now(),
                    name,
                    role,
                    title: role,
                    lastContact: new Date().toISOString()
                });
                persistFirms('user');
                openFirmPanel(state.currentFirm);
            };
            
            window.onresize = () => {
                if (state.viewMode === 'scatter') resizeCanvas();
                if (state.viewMode === 'map' && state.mapProjection) {
                    const container = $('map-container');
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    state.mapProjection.scale((width/2/Math.PI)*0.8).translate([width/2, height/1.8]);
                    updateMapBubbles();
                }
            };
        }

        // Initialize
        function init() {
            // Populate dropdowns
            $('form-location').innerHTML = '<option value="">Select Location</option>' + 
                Object.keys(CONFIG.CITY_COORDS).map(c => `<option value="${c}">${c}</option>`).join('');
            
            $('form-stage').innerHTML = CONFIG.STAGE_NAMES.map((n,i) => 
                `<option value="${i+1}">${i+1} - ${n}</option>`).join('');
            
            $('progress-stages').innerHTML = CONFIG.STAGE_NAMES.map(n => 
                `<span>${n}</span>`).join('');
            
            loadData();
            setupCanvas();
            initMap();
            setupEventListeners();
            setView('map');
        }

        init();
    </script>
</body>
</html>